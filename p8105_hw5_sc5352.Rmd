---
title: "p8105_hw5_sc5352"
author: "Chrissy Chen"
date: "2023-11-08"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(readr)
library(tidyverse)
library(dplyr)
library(broom)
library(ggplot2)
```

#### Problem 2

```{r}
# create dataframe to collect file names
file_names = list.files(path = "data", pattern = "\\.csv$", full.names = TRUE)
data = data.frame(file_name = file_names, stringsAsFactors = FALSE)

# write data from each .csv into the dataframe as a new variable
data = 
  data |>
  mutate(result = map(file_name, read_csv))

# tidy the id from file names to arm + subject ID
tidynames = function(x) {
  x = gsub(".csv$", "", x)
}

# dataframe with id and results columns
tidy_data = 
  data |>
  mutate(id = map(file_name, basename)) |>
  mutate(id = map(id, tidynames)) |>
  select(-file_name) |>
  select(id, result) 

# unlist results columns for plotting
unlist_tidydata = 
  tidy_data |>
  unnest_wider(result) |>
  pivot_longer(cols = starts_with("week_"), 
               names_to = "week",
               values_to = "value") |>
  mutate(id = as.character(id))

# draw the plot
df = 
  as.data.frame(unlist_tidydata) |>
  na.omit() |>
  mutate(
    arm = substr(id, 1, 3),
    arm = case_match(
             arm,
             "con" ~ "control",
             "exp" ~ "experimental"
           ))

ggplot(df, aes(x = week, y = value, group = as.factor(id), color = as.factor(id))) +
  geom_line() +
  labs(x = "Week", y = "Value", title = "Spaghetti Plot") +
  theme_minimal() +
  facet_grid(~arm)
```
The overall values for the experimental group are higher than the control group.  
The values for the experimental group are increasing as the time goes on, but the values for the control group do not change much.  

#### Problem 3

```{r}
# Generate 5000 datasets from the model with mu = 0
set.seed(1)
sim_one = function(n, mu = 0, sigma = 5) {
  
  sim_data = tibble(
    x = rnorm(n, mean = mu, sd = sigma),
  )
  
  sim_data |> 
    summarize(
      mu_hat = mean(x),
      p_value = tidy(t.test(x, mu = 0))$p.value,
      estimate = tidy(t.test(x, mu = 0))$estimate
    )
}
output = vector("list", 5000)

for (i in 1:5000) {
  output[[i]] = sim_one(30)
}

sim_results = bind_rows(output)
```

```{r}
set.seed(2)

mu_values = c(0, 1, 2, 3, 4, 5, 6)

results = data.frame()

for (mu in mu_values) {
  for (i in 1:5000) {
    sample_data = rnorm(30, mean = mu, sd = 5)
    test_result = tidy(t.test(sample_data, mu = 0))
    results = rbind(results, c(mu, test_result$estimate, test_result$p.value))
  }
}

colnames(results) = c("true_mu", "estimated_mu", "p_value")
results =
  results |>
  mutate(reject_null = p_value < 0.05)

power_df = 
  results |>
  group_by(true_mu) |>
  summarise(power = mean(reject_null))

estimated_mu = 
  results |>
  group_by(true_mu) |>
  summarise(estimated_mu = mean(estimated_mu))

estimated_mu_rejected = 
  results |>
  filter(reject_null == TRUE) |>
  group_by(true_mu) |>
  summarise(estimated_mu_rejected = mean(estimated_mu))

# Plotting
ggplot(power_df, aes(x = true_mu, y = power)) + 
  geom_line() +
  labs(title = "Power vs. True Mean", x = "True Mean (Mu)", y = "Power")

ggplot() + 
  geom_line(data = estimated_mu, aes(x = true_mu, y = estimated_mu), color = "blue") +
  geom_line(data = estimated_mu_rejected, aes(x = true_mu, y = estimated_mu_rejected), color = "red") +
  labs(title = "Average Estimated Mu vs. True Mean", x = "True Mean (Mu)", y = "Average Estimated Mu")
```
The power increases as the effect size increases and close to one.  
The average estimated \mu across tests for which the null is rejected approximately equal to the true value of \mu as the true mean increases, but there is a large division when the \mu equals to one.  
